<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Literary Companion</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            background-color: #f4f4f9;
        }
        h1 {
            text-align: center;
            padding: 1rem;
            margin: 0;
            background-color: #4a4a4a;
            color: white;
        }
        .container {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
            padding: 1rem;
            gap: 1rem;
        }
        .pane {
            flex: 1;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow-y: scroll;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .pane h2 {
            position: sticky;
            top: -17px; /* Adjust based on padding */
            background: white;
            padding: 1rem 0;
            margin-top: -1rem;
            border-bottom: 1px solid #ddd;
        }
        .pane p {
            margin: 0 0 1.5em 0;
            line-height: 1.6;
        }
        .controls {
            display: flex;
            justify-content: center;
            padding: 0.5rem;
        }
        #fun-fact-toggle {
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            transition: background-color 0.3s;
        }
        #fun-fact-toggle:hover {
            background-color: #0056b3;
        }
        #fun-fact-toggle:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .fun-fact-card {
            background-color: #eef7ff;
            border-left: 5px solid #007bff;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 5px;
        }
        .fun-fact-card h3 {
            margin-top: 0;
            color: #0056b3;
        }
        #progress-indicator {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            font-size: 0.9rem;
            z-index: 1000;
        }
    </style>
</head>
<body>

    <h1>Literary Companion</h1>

    <div class="container">
        <div id="original-text" class="pane">
            <h2>Original Text</h2>
            </div>

        <div id="dynamic-content" class="pane">
            <h2>Modern Translation</h2>
            </div>
    </div>

    <div class="controls">
        <button id="fun-fact-toggle">Show Fun Facts</button>
    </div>

    <div id="progress-indicator">Chapter 1, Paragraph 1</div>

    <script>
        // --- API CONFIGURATION ---
        const NOVEL_API_URL = "/api/get_novel_content";

        // --- DOM ELEMENTS ---
        const originalPane = document.getElementById('original-text');
        const dynamicPane = document.getElementById('dynamic-content');
        let dynamicPaneTitle = dynamicPane.querySelector('h2');
        const funFactButton = document.getElementById('fun-fact-toggle');
        const progressIndicator = document.getElementById('progress-indicator');

        // --- STATE MANAGEMENT ---
        let paragraphsData = [];
        let isShowingFunFacts = false;
        let lastVisibleParagraphId = null;
        let funFactsCache = {};
        const readingSessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

        // --- LOGIC ---

        // 1. FETCH AND RENDER NOVEL
        async function loadNovel() {
            funFactButton.disabled = true;
            funFactButton.textContent = "Loading Novel...";
            try {
                const response = await fetch(NOVEL_API_URL);
                if (!response.ok) {
                    throw new Error(`Failed to fetch novel: ${response.statusText}`);
                }
                const data = await response.json();
                paragraphsData = data.paragraphs;

                originalPane.innerHTML = '<h2>Original Text</h2>';
                dynamicPane.innerHTML = '<h2>Modern Translation</h2>';

                paragraphsData.forEach(p => {
                    const originalP = document.createElement('p');
                    originalP.id = `original-${p.paragraph_id}`;
                    originalP.textContent = p.original_text;
                    originalPane.appendChild(originalP);

                    const translatedP = document.createElement('p');
                    translatedP.id = `translated-${p.paragraph_id}`;
                    translatedP.textContent = p.translated_text;
                    dynamicPane.appendChild(translatedP);
                });

                setupIntersectionObserver();
                funFactButton.disabled = false;
                funFactButton.textContent = "Show Fun Facts";

            } catch (error) {
                console.error("Error loading novel:", error);
                originalPane.innerHTML += `<p style="color:red;">Could not load the novel. Check browser console for errors.</p>`;
                funFactButton.textContent = "Error Loading";
            }
        }

        // 2. SYNCHRONIZED SCROLLING & PROGRESS TRACKING
        function setupIntersectionObserver() {
            const options = {
                root: originalPane,
                rootMargin: '0px',
                threshold: 0.5
            };

            const observer = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        lastVisibleParagraphId = entry.target.id.replace('original-', '');
                        updateProgressIndicator(lastVisibleParagraphId);
                        const correspondingTranslatedP = document.getElementById(`translated-${lastVisibleParagraphId}`);
                        if (correspondingTranslatedP && !isShowingFunFacts) {
                            correspondingTranslatedP.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                });
            }, options);

            const originalParagraphs = originalPane.querySelectorAll('p');
            originalParagraphs.forEach(p => observer.observe(p));
        }

        function updateProgressIndicator(paragraphId) {
            const paragraph = paragraphsData.find(p => p.paragraph_id === paragraphId);
            if (paragraph) {
                progressIndicator.textContent = `Chapter: ${paragraph.chapter_number}, Paragraph: ${paragraph.paragraph_in_chapter}`;
            }
        }

        // 3. FUN FACT GENERATION
        funFactButton.addEventListener('click', async () => {
            if (isShowingFunFacts) {
                renderTranslationView();
                isShowingFunFacts = false;
                funFactButton.textContent = "Show Fun Facts";
                return;
            }
            
            if (!lastVisibleParagraphId) {
                alert("Please scroll down to a paragraph first.");
                return;
            }

            const currentParagraph = paragraphsData.find(p => p.paragraph_id === lastVisibleParagraphId);
            const cacheKey = `${currentParagraph.chapter_number}-${currentParagraph.paragraph_in_chapter}`;

            if (funFactsCache[cacheKey]) {
                renderFunFactsView(funFactsCache[cacheKey]);
                isShowingFunFacts = true;
                funFactButton.textContent = "Show Modern English";
                return;
            }

            funFactButton.disabled = true;
            funFactButton.textContent = "Generating...";

            try {
                const lastReadIndex = paragraphsData.findIndex(p => p.paragraph_id === lastVisibleParagraphId);
                const textSegment = paragraphsData.slice(0, lastReadIndex + 1).map(p => p.translated_text).join('\n\n');

                const response = await fetch('/generate_fun_facts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text_segment: textSegment,
                        session_id: readingSessionId,
                        chapter_number: currentParagraph.chapter_number,
                        paragraph_in_chapter: currentParagraph.paragraph_in_chapter
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.statusText}`);
                }

                const funFacts = await response.json();
                funFactsCache[cacheKey] = funFacts;
        
                renderFunFactsView(funFacts);
                isShowingFunFacts = true;
                funFactButton.textContent = "Show Modern English";

            } catch (error) {
                console.error("Error generating fun facts:", error);
                alert("Could not generate fun facts. See console for details.");
            } finally {
                funFactButton.disabled = false;
            }
        });
        
        function renderFunFactsView(facts) {
            dynamicPaneTitle = dynamicPane.querySelector('h2');
            dynamicPaneTitle.textContent = "Fun Facts";
            const contentArea = dynamicPane;
            contentArea.innerHTML = '<h2>Fun Facts</h2>';

            for (const key in facts) {
                if (facts[key] && facts[key].fact) {
                    const card = document.createElement('div');
                    card.className = 'fun-fact-card';
                    const title = document.createElement('h3');
                    title.textContent = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const factText = document.createElement('p');
                    factText.textContent = facts[key].fact.replace(title.textContent + ':', '').trim();
                    card.appendChild(title);
                    card.appendChild(factText);
                    contentArea.appendChild(card);
                }
            }
        }
        
        function renderTranslationView() {
            dynamicPaneTitle.textContent = "Modern Translation";
            const contentArea = dynamicPane;
            contentArea.innerHTML = '<h2>Modern Translation</h2>';

            paragraphsData.forEach(p => {
                const translatedP = document.createElement('p');
                translatedP.id = `translated-${p.paragraph_id}`;
                translatedP.textContent = p.translated_text;
                contentArea.appendChild(translatedP);
            });
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', loadNovel);
    </script>
    
</body>
</html>